---
title: "Selection of the best class of models"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading libraries
```{r}
library('lubridate') # Library for date management
library('ranger') # Library for Random Forest
library('caret') # Library for dummy variables and RMSE
library('xgboost') # Library for Xgboost
library('rpart') # Library for Classfication and Regression Trees
library("glmnet") # Library for LASSO and Ridge regression
```


# Modelisation

## Random Forest :
```{r}
# Loading data
load("Donnees pretes pour modelisation.Rdata")

# Model training
rf <- ranger(ecart_sais~., data = visiteurs[, -1])

# Make prediction on test set and compute RMSE
visiteurs_test$predict <- predict(rf, visiteurs_test)$predictions
RMSE(pred = visiteurs_test$predict, obs = visiteurs_test$ecart_sais) # RMSE: 267.1256

# Mean pourcentage error of the prediction
mean(abs(visiteurs_test$predict - visiteurs_test$ecart_sais)*100/(visiteurs_test$ecart_sais + visiteurs_test$saison))

# Plot of the real attendance against predicted for 2017
ggplot(visiteurs_test[year(visiteurs_test$DATE) == 2017,]) + 
    geom_line(aes(x = DATE, y = predict + saison), col = "red") + 
    geom_line(aes(x = DATE, y = ecart_sais + saison)) + theme_bw()

visiteurs_test$predict <- NULL
```

## XGBoost :
```{r}
# Loading data
load("Donnees pretes pour modelisation.Rdata")

# Factor variables to dummy variables
DATE <- visiteurs_test$DATE
dmy <- dummyVars( ~. , data = visiteurs[,-1], fullRank = T)
visiteurs <- data.frame(predict(dmy, newdata = visiteurs))
dmy <- dummyVars( ~. , data = visiteurs_test[,-1], fullRank = T)
visiteurs_test <- data.frame(predict(dmy, newdata = visiteurs_test))
visiteurs$descr_generalePas.d.obs <- NULL # This doesn't occur in the test set 

# Data in the right format
dtrain <- xgb.DMatrix(data = as.matrix(visiteurs[,-33]), label=as.matrix(visiteurs$ecart_sais))
dtest <- xgb.DMatrix(data = as.matrix(visiteurs_test[,-33]), label=as.matrix(visiteurs_test$ecart_sais))
watchlist <- list(train=dtrain, test=dtest)

# Paremeters
params <- list(eta = 0.01, gamma = 10, max_depth = 3, subsample = .7, colsample_bytree = .7, min_child_weight = 1)

# Model training 
xgb <- xgb.train(params = params, data = dtrain, watchlist=watchlist, verbose=2, nthread=4, nrounds = 5000, early_stopping_rounds = 150)

# Progression of RMSE with the number of trees 
ggplot(xgb$evaluation_log) + geom_line(aes(x = iter, y= test_rmse)) + geom_line(aes(x = iter, y= train_rmse), color = "red") + theme_bw()

# Make prediction on test set and compute RMSE
visiteurs_test$predict <- predict(xgb, dtest)
RMSE(pred = visiteurs_test$predict, obs = visiteurs_test$ecart_sais) # RMSE: 250.3095
visiteurs_test$predict <- NULL
```

## CART :
```{r}
# Loading data
load("Donnees pretes pour modelisation.Rdata")

# Model training 
arbre <- rpart(ecart_sais~., data = visiteurs[,-1], cp = 0.0008, model=TRUE)

# Quickly choose a good complexity parameter and plot the tree
plotcp(arbre)
rpart.plot::rpart.plot(arbre)

# Make prediction on test set and compute RMSE
visiteurs_test$predict <- predict(arbre, visiteurs_test)
RMSE(pred = visiteurs_test$predict, obs = visiteurs_test$ecart_sais)
visiteurs_test$predict <- NULL
```

## Simple linear regression :

### Linear regression
```{r}
# Loading data
load("Donnees pretes pour modelisation.Rdata")

# Model training 
lm <- lm(ecart_sais ~ ., data = visiteurs)

# Make prediction on test set and compute RMSE
visiteurs_test$predict <- predict(lm, visiteurs_test)
caret::RMSE(pred = visiteurs_test$predict, obs = visiteurs_test$ecart_sais) # RMSE: 312.459
```

### LASSO 
```{r}
# Loading data
load("Donnees pretes pour modelisation.Rdata")

# Factor variables to dummy variables
DATE <- visiteurs_test$DATE
dmy <- dummyVars( ~. , data = visiteurs[,-1], fullRank = T)
visiteurs <- data.frame(predict(dmy, newdata = visiteurs))
dmy <- dummyVars( ~. , data = visiteurs_test[,-1], fullRank = T)
visiteurs_test <- data.frame(predict(dmy, newdata = visiteurs_test))
visiteurs$descr_generalePas.d.obs <- NULL

# Model training 
lasso.cv <- cv.glmnet(x = as.matrix(visiteurs[,-33]), y = visiteurs$ecart_sais, family = "gaussian", nfolds = 5, alpha = 1)

# Make prediction on test set and compute RMSE
visiteurs_test$predict <- predict(lasso.cv, newx = as.matrix(visiteurs_test[,-33]), s = "lambda.1se")[,1]
caret::RMSE(pred = visiteurs_test$predict, obs = visiteurs_test$ecart_sais) # RMSE: 313.1293
visiteurs_test$predict <- NULL
```

## Linear regression with interaction variables :

### Linear regression
```{r}
# Loading data
load("Donnees pretes pour modelisation.Rdata")

# Creating all the interaction variables 
DATE <- visiteurs$DATE
DATE_test <- visiteurs_test$DATE
ecart_sais <- visiteurs$ecart_sais
ecart_sais_test <- visiteurs_test$ecart_sais
visiteurs$DATE <- NULL
visiteurs_test$DATE <- NULL
visiteurs_test$ecart_sais <- NULL
visiteurs$ecart_sais <- NULL

visiteurs <- data.frame(model.matrix(~.^2-1, visiteurs))
visiteurs_test <- data.frame(model.matrix(~.^2-1, visiteurs_test))

variables <- names(visiteurs)

visiteurs_test$ecart_sais <- ecart_sais_test
visiteurs$ecart_sais <- ecart_sais

# Iteratively remove variables based on the significance of the test H0: coefficient = 0
# Threshold for stoping the procedure : p_val = 0.01
lm <- lm(ecart_sais ~ ., data = visiteurs[, c(variables, "ecart_sais")])
seuil_signif <- max(summary(lm)$coefficients[,4])

while(seuil_signif > 0.01){
  
  if(sum(is.na(lm$coefficients)) > 0){
    variables <- variables[variables != sample(names(lm$coefficients[is.na(lm$coefficients)]), 1)]
  }
  else{variables <- variables[variables != names(which.max(summary(lm)$coefficients[,4]))]}
  
  lm <- lm(ecart_sais ~ ., data = visiteurs[, c(variables, "ecart_sais")])
  seuil_signif <- max(summary(lm)$coefficients[,4])
  print(length(variables))
  print(seuil_signif)
}
  
lm <- lm(ecart_sais ~ ., data = visiteurs[, variables])
#save.image("Variables regression linéaire.Rdata") 

# Make prediction on test set and compute RMSE
visiteurs_test$predict <- predict(lm, visiteurs_test)
caret::RMSE(pred = visiteurs_test$predict, obs = visiteurs_test$ecart_sais) # RMSE : 269.3086
visiteurs_test$predict <- NULL
```

### LASSO :
```{r}
# Loading data
load("Donnees pretes pour modelisation.Rdata")

# Creating all the interaction variables 
DATE <- visiteurs$DATE
DATE_test <- visiteurs_test$DATE
ecart_sais <- visiteurs$ecart_sais
ecart_sais_test <- visiteurs_test$ecart_sais
visiteurs$DATE <- NULL
visiteurs_test$DATE <- NULL
visiteurs_test$ecart_sais <- NULL
visiteurs$ecart_sais <- NULL

visiteurs$descr_generale[visiteurs$descr_generale == "Pas d'obs"] <- "Couvert - Soleil"
visiteurs <- data.frame(model.matrix(~.^2-1, visiteurs))
visiteurs_test <- data.frame(model.matrix(~.^2-1, visiteurs_test))

# Model training 
lasso.cv <- cv.glmnet(x = as.matrix(visiteurs), y = ecart_sais, family = "gaussian", nfolds = 5, alpha = 1)

# Make prediction on test set and compute RMSE
visiteurs_test$predict <- predict(lasso.cv, newx = as.matrix(visiteurs_test), s = "lambda.1se")[,1]
caret::RMSE(pred = visiteurs_test$predict, obs = ecart_sais_test) # RMSE: 274.9008
visiteurs_test$predict <- NULL
```

### Ridge :
```{r}
# Loading data
load("Donnees pretes pour modelisation.Rdata")

# Creating all the interaction variables 
DATE <- visiteurs$DATE
DATE_test <- visiteurs_test$DATE
ecart_sais <- visiteurs$ecart_sais
ecart_sais_test <- visiteurs_test$ecart_sais
visiteurs$DATE <- NULL
visiteurs_test$DATE <- NULL
visiteurs_test$ecart_sais <- NULL
visiteurs$ecart_sais <- NULL

visiteurs$descr_generale[visiteurs$descr_generale == "Pas d'obs"] <- "Couvert - Soleil"
visiteurs <- data.frame(model.matrix(~.^2-1, visiteurs))
visiteurs_test <- data.frame(model.matrix(~.^2-1, visiteurs_test))

# Model training 
lasso.cv <- cv.glmnet(x = as.matrix(visiteurs), y = ecart_sais, family = "gaussian", nfolds = 5, alpha = 0)

# Make prediction on test set and compute RMSE
visiteurs_test$predict <- predict(lasso.cv, newx = as.matrix(visiteurs_test), s = "lambda.1se")[,1]
caret::RMSE(pred = visiteurs_test$predict, obs = ecart_sais_test) # RMSE: 267.2635
visiteurs_test$predict <- NULL
```

### elastic net :
```{r}
# Loading data
load("Donnees pretes pour modelisation.Rdata")

# Creating all the interaction variables 
DATE <- visiteurs$DATE
DATE_test <- visiteurs_test$DATE
ecart_sais <- visiteurs$ecart_sais
ecart_sais_test <- visiteurs_test$ecart_sais
visiteurs$DATE <- NULL
visiteurs_test$DATE <- NULL
visiteurs_test$ecart_sais <- NULL
visiteurs$ecart_sais <- NULL

visiteurs$descr_generale[visiteurs$descr_generale == "Pas d'obs"] <- "Couvert - Soleil"
visiteurs <- data.frame(model.matrix(~.^2-1, visiteurs))
visiteurs_test <- data.frame(model.matrix(~.^2-1, visiteurs_test))

# Model training 
lasso.cv <- cv.glmnet(x = as.matrix(visiteurs), y = ecart_sais, family = "gaussian", nfolds = 5, alpha = .5)

# Make prediction on test set and compute RMSE
visiteurs_test$predict <- predict(lasso.cv, newx = as.matrix(visiteurs_test), s = "lambda.1se")[,1]
caret::RMSE(pred = visiteurs_test$predict, obs = ecart_sais_test) # RMSE: 272.9989
visiteurs_test$predict <- NULL
```


Final results :

| Model                                        | RMSE          |
| -------------------------------------------- |:-------------:|
| Random Forest                                | 267.1256      |
| **Xgboost**                                  | **250.3095**  |
| CART                                         | 312.4196      |
| Linear regression                            | 312.459       |
| LASSO regression                             | 313.1293      |
| Linear regression with interaction variables | 269.3086      |
| LASSO regression with interaction variables  | 274.9008      |
| Ridge regression with interaction variables  | 267.2635      |
| Elastic net with interaction variables       | 272.9989      |


## TESTS Séries temporelles

### Moyennes mobiles
```{r}
library("forecast")
nb_visit <- ts(visiteurs$Nb_visiteurs[1:9672], start = c(1991, 1,1), frequency = 365)
plot(nb_visit)
model <- decompose(nb_visit[], "additive")
plot(model)
```

```{r}
data <- data.frame(date = visiteurs$DATE[1:9672], serie = model$x, saison = model$seasonal, trend = model$trend, random = model$random)
ggplot(data[8000:10030,]) + geom_line(aes(x = date, y = trend)) + theme_bw()

ggplot(data[1:10030,]) + geom_line(aes(x = date, y = trend)) + theme_bw() + scale_x_date(breaks = date_breaks("years"), labels = date_format("%y"))

ggplot(data[1:10030,]) + geom_line(aes(x = date, y = random + trend - 887.32)) + theme_bw() + scale_x_date(breaks = date_breaks("years"), labels = date_format("%y"))

ggplot(data[366:730,]) + geom_line(aes(x = date, y = saison + 887.32)) + theme_bw() + scale_x_date(breaks = date_breaks("months"), labels = date_format("%b"))

ggplot(data[8000:10402,]) + geom_line(aes(x = date, y = serie)) + geom_line(aes(x = date, y = saison + 887.32), col = "red") + theme_bw() + scale_x_date(breaks = date_breaks("months"), labels = date_format("%b"))

```

### Moyenne Min Max par jours
```{r}
test <- visiteurs[1:9672,] %>% group_by(Mois, day(DATE)) %>% summarize(min = min(Nb_visiteurs), max = max(Nb_visiteurs), moy = mean(Nb_visiteurs)) 
test$DATE <- visiteurs$DATE[1:365]
ggplot(test) + geom_line(aes(x=DATE, y=min), col = "blue") + geom_line(aes(x=DATE, y=max), col = "red") + geom_line(aes(x=DATE, y=moy)) + theme_bw() + scale_x_date(breaks = date_breaks("months"), labels = date_format("%b")) + ylab("")
test$x <- substr(test$DATE, start = 6, stop = 10)
visiteurs$x <- substr(visiteurs$DATE, start = 6, stop = 10)

visiteurs <- left_join(visiteurs, test[,c(5,7)], by = "x")
visiteurs$x <- NULL
visiteurs$Nb_visiteurs[visiteurs$moy < 100] <- NA
```


### Test saison = moyenne de chanque jour de l'année : 
```{r}
stat_par_jour <- visiteurs[1:9672,] %>% group_by(Mois, Jour, wkd_special, mille_feux, vacances) %>% summarize(saison = mean(Nb_visiteurs)) 
visiteurs <- left_join(visiteurs, stat_par_jour, by = c("Mois", "Jour", "wkd_special", "mille_feux", "vacances")) 
ggplot(visiteurs[1:365,]) + geom_line(aes(x=DATE, y=saison)) + theme_bw() + scale_x_date(breaks = date_breaks("months"), labels = date_format("%b"))

visiteurs$visit_sans_sais <- (visiteurs$Nb_visiteurs - visiteurs$saison)
ggplot(visiteurs[9500:10402,]) + geom_line(aes(x=DATE, y=visit_sans_sais)) + theme_bw() + scale_x_date(breaks = date_breaks("months"), labels = date_format("%b")) 
```


### ARIMA
```{r}
nb_visit <- ts(visiteurs$Nb_visiteurs[1:9672], start = c(1991, 1,1), frequency = 365)

temp <- visiteurs
temp$DATE <- NULL
temp$annee <- NULL
temp$Mois <- NULL
dmy <- dummyVars( ~. , data = temp, fullRank = T)
temp <- data.frame(predict(dmy, newdata = temp))
temp$Trop_chaud <- 0
temp$Trop_chaud[temp$Temp.max > 28] <- 1
  
#ARIMA:
arima <- auto.arima(nb_visit, d=0, D=1, start.p=5, start.q=0, start.P=0, start.Q=0, ic="bic", trace = T, xreg = as.matrix(temp[1:9672,c(2,11:15)]) )
prev <- forecast(arima, xreg = as.matrix(temp[9673:10402,c(2,11:15)]))
data <- data.frame(date = visiteurs$DATE[9673:10402], nb_vis = visiteurs$Nb_visiteurs[9673:10402], prev = prev$mean)
ggplot(data) + geom_line(aes(x = date, y = nb_vis)) + geom_line(aes(x = date, y = prev), col = "red") + theme()

visiteurs$pred <- c(prev$x - prev$residuals, prev$mean)
ggplot(visiteurs[8943:9672,]) + geom_line(aes(x=DATE, y=Nb_visiteurs)) + geom_line(aes(x = DATE, y = pred), col = "red") + theme()
visiteurs$res <- c(prev$residuals, prev$mean-visiteurs$Nb_visiteurs[9673:10402])
ggplot(visiteurs) + geom_point(aes(x=DATE, y=res)) + theme()
```
